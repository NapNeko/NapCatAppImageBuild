name: Build NapCat QQ AppImage (with dependencies)

on:
  workflow_dispatch:
    inputs:
      napcat_version:
        description: 'NapCat Version (e.g., v4.8.119)'
        required: true
        default: 'v4.8.119'
      qq_version:
        description: 'QQ Version (完整下载 URL)'
        required: true
        default: 'https://dldir1v6.qq.com/qqfile/qq/QQNT/c773cdf7/linuxqq_3.2.19-39038_x86_64.AppImage'

jobs:
  build:
    runs-on: debian-12

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            wget unzip sed fuse2 patchelf libglib2.0-0 libgtk-3-0 libx11-6 \
            libnss3 libgcrypt20 libxext6 libxrender1 libasound2 libdbus-1-3 \
            libxss1 libxtst6 libxkbfile1 libpangocairo-1.0-0 xvfb xauth

      - name: Download QQ AppImage
        run: |
          wget -O QQ.AppImage "${{ github.event.inputs.qq_version }}"
          chmod +x QQ.AppImage

      - name: Extract QQ AppImage
        run: |
          ./QQ.AppImage --appimage-extract
          mv squashfs-root QQ.AppDir

      - name: Download NapCat
        run: |
          wget -O NapCat.Shell.zip https://github.com/NapNeko/NapCatQQ/releases/download/${{ github.event.inputs.napcat_version }}/NapCat.Shell.zip
          unzip NapCat.Shell.zip -d NapCat
          rm NapCat.Shell.zip

      - name: Inject NapCat into QQ
        run: |
          mkdir -p QQ.AppDir/napcat
          cp -r NapCat/* QQ.AppDir/napcat/
          echo "(async () => {await import('file:///napcat/napcat.mjs');})();" > QQ.AppDir/resources/app/loadNapCat.js
          sed -i 's|"main": "[^"]*"|"main": "./loadNapCat.js"|' QQ.AppDir/resources/app/package.json

      - name: Download linuxdeploy and plugin
        run: |
          wget -O linuxdeploy https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          chmod +x linuxdeploy
          wget -O linuxdeploy-plugin-appimage https://github.com/linuxdeploy/linuxdeploy-plugin-appimage/releases/download/continuous/linuxdeploy-plugin-appimage-x86_64.AppImage
          chmod +x linuxdeploy-plugin-appimage

      - name: Make QQ executable
        run: |
          chmod +x QQ.AppDir/qq

      - name: Build self-contained AppImage
        run: |
          ./linuxdeploy --appdir QQ.AppDir \
            --output appimage \
            --plugin AppImage \
            --executable QQ.AppDir/qq

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: QQ-NapCat-${{ github.event.inputs.napcat_version }}
          path: "*.AppImage"
