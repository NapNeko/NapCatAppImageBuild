name: Build NapCat QQ AppImage (Ubuntu container, self-contained)

on:
  workflow_dispatch:
    inputs:
      napcat_version:
        description: 'NapCat Version (e.g., v4.8.119)'
        required: true
        default: 'v4.8.119'
      qq_version:
        description: 'QQ AppImage URL (完整下载链接)'
        required: true
        default: 'https://dldir1v6.qq.com/qqfile/qq/QQNT/c773cdf7/linuxqq_3.2.19-39038_x86_64.AppImage'

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: ubuntu:22.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install build tools and specified runtime dependencies
        run: |
          apt-get update
          apt-get install -y --no-install-recommends \
            wget unzip sed patchelf file curl \
            libglib2.0-0 libgtk-3-0 libx11-6 libnss3 libgcrypt20 \
            libxext6 libxrender1 libasound2 libdbus-1-3 libxss1 \
            libxtst6 libxkbfile1 libpangocairo-1.0-0 xvfb xauth

      - name: Download QQ AppImage
        run: |
          wget -O QQ.AppImage "${{ github.event.inputs.qq_version }}"
          chmod +x QQ.AppImage

      - name: Extract QQ AppImage
        run: |
          ./QQ.AppImage --appimage-extract
          mv squashfs-root QQ.AppDir

      - name: Download NapCat
        run: |
          wget -O NapCat.Shell.zip "https://github.com/NapNeko/NapCatQQ/releases/download/${{ github.event.inputs.napcat_version }}/NapCat.Shell.zip"
          unzip NapCat.Shell.zip -d NapCat
          rm NapCat.Shell.zip

      - name: Inject NapCat into QQ
        run: |
          mkdir -p QQ.AppDir/napcat
          cp -r NapCat/* QQ.AppDir/napcat/
          echo "(async () => {await import('file:///napcat/napcat.mjs');})();" > QQ.AppDir/resources/app/loadNapCat.js
          sed -i 's|"main": "[^"]*"|"main": "./loadNapCat.js"|' QQ.AppDir/resources/app/package.json

      - name: Prepare AppDir structure
        run: |
          mkdir -p QQ.AppDir/usr/lib
          cat > QQ.AppDir/qq.desktop <<EOL
          [Desktop Entry]
          Name=QQ
          Comment=QQ Instant Messenger
          Exec=qq
          Icon=qq
          Type=Application
          Categories=Network;InstantMessaging;
          EOL
          if [ -f QQ.AppDir/qq.png ]; then
            cp QQ.AppDir/qq.png QQ.AppDir/
          fi
      
      # 步骤 1: 注入指定库，并严格排除 Glibc
      - name: Inject specified system libraries into AppDir (Glibc Excluded)
        run: |
          echo "Injecting libraries from specified packages..."
          PACKAGE_LIST="libglib2.0-0 libgtk-3-0 libx11-6 libnss3 libgcrypt20 libxext6 libxrender1 libasound2 libdbus-1-3 libxss1 libxtst6 libxkbfile1 libpangocairo-1.0-0"
          
          # 定义一个 Glibc 及其他核心库的排除列表
          BLACKLIST_PATTERN='lib(c|dl|m|pthread|rt|resolv|nss_dns|nss_files|nss_compat)\.so'

          for PKG in $PACKAGE_LIST; do
            echo "--- Processing package: $PKG ---"
            dpkg -L "$PKG" | grep '\.so\(\.[0-9.]*\)*$' | \
            # 【双重保险】在这里也排除 Glibc，防止意外注入
            egrep -v "$BLACKLIST_PATTERN" | \
            while read -r lib_file; do
              if [ -f "$lib_file" ]; then
                echo "Copying $lib_file to usr/lib/"
                cp -v "$lib_file" QQ.AppDir/usr/lib/
              fi
            done
          done

      # 步骤 2: ldd 扫描补充依赖，并严格排除 Glibc
      - name: Manually bundle remaining dependencies (Glibc Excluded)
        run: |
          echo "Scanning for any other missed dependencies..."
          # 【关键步骤】这个 egrep -v 命令确保不打包 Glibc 和其他基础系统库
          # 这是制作可移植 AppImage 的核心原则
          ldd QQ.AppDir/usr/bin/qq | grep "=> /" | awk '{print $3}' | \
          egrep -v 'ld-linux|lib(c|dl|m|pthread|rt|resolv|nss_dns|nss_files|nss_compat|util|X11|Xext|GL|GLdispatch|EGL)\.so' | \
          while read -r lib_path; do
              if [ -f "$lib_path" ]; then
                cp -nv "$lib_path" QQ.AppDir/usr/lib/
              fi
          done

      - name: Download appimagetool
        run: |
          wget -O appimagetool.AppImage "https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage"
          chmod +x appimagetool.AppImage

      - name: Build the AppImage
        run: |
          ./appimagetool.AppImage QQ.AppDir
          mv QQ-x86_64.AppImage QQ-NapCat-${{ github.event.inputs.napcat_version }}.AppImage

      - name: Rename and upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: "QQ-NapCat-${{ github.event.inputs.napcat_version }}"
          path: "QQ-NapCat-${{ github.event.inputs.napcat_version }}.AppImage"
