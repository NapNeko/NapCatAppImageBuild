name: Build NapCat AppImage
on:
  workflow_dispatch:
    inputs:
      napcat_version:
        description: 'NapCat Version (e.g., v4.8.119)'
        required: true
        default: 'v4.8.119'
      qq_version:
        description: 'QQ AppImage URL (完整下载链接)'
        required: true
        default: 'https://dldir1v6.qq.com/qqfile/qq/QQNT/c773cdf7/linuxqq_3.2.19-39038_x86_64.AppImage'

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: ubuntu:22.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install build tools and runtime dependencies
        run: |
          apt-get update
          apt-get install -y --no-install-recommends \
            wget unzip sed patchelf file curl \
            libglib2.0-0 libgtk-3-0 libx11-6 libnss3 libgcrypt20 libgbm1 \
            libxext6 libxrender1 libasound2 libdbus-1-3 libxss1 \
            libxtst6 libxkbfile1 libpangocairo-1.0-0 xvfb xauth ca-certificates
            update-ca-certificates

      - name: Download QQ AppImage
        run: |
          wget -O QQ.AppImage "${{ github.event.inputs.qq_version }}"
          chmod +x QQ.AppImage

      - name: Extract QQ AppImage
        run: |
          ./QQ.AppImage --appimage-extract
          mv squashfs-root QQ.AppDir

      - name: Download NapCat
        run: |
          wget -O NapCat.Shell.zip "https://github.com/NapNeko/NapCatQQ/releases/download/${{ github.event.inputs.napcat_version }}/NapCat.Shell.zip"
          unzip NapCat.Shell.zip -d NapCat
          rm NapCat.Shell.zip

      - name: Inject NapCat into QQ
        run: |
          mkdir -p QQ.AppDir/napcat
          cp -r NapCat/* QQ.AppDir/napcat/
          echo "const path=require('path');const{pathToFileURL}=require('url');(async()=>{await import(pathToFileURL(path.join(__dirname,'../../napcat/napcat.mjs')).href);})();" > QQ.AppDir/resources/app/loadNapCat.js
          sed -i 's|"main": "[^"]*"|"main": "./loadNapCat.js"|' QQ.AppDir/resources/app/package.json
     
      - name: Modify AppRun for xvfb and NAPCAT_WORKDIR
        run: |
          sed -i '2i\export NAPCAT_WORKDIR=$(pwd)' QQ.AppDir/AppRun
          sed -i 's|exec "$BIN"|xvfb-run -a exec "$BIN"|g' QQ.AppDir/AppRun
          rm -rf QQ.AppDir/resources/app/major.node
          rm -rf QQ.AppDir/resources/app/avsdk
          rm -rf QQ.AppDir/resources/app/application.asar
          rm -rf QQ.AppDir/resources/app/initIpc_ia32.node
          rm -rf QQ.AppDir/resources/app/initIpc_x64.node
          rm -rf QQ.AppDir/resources/app/iohook.node
          rm -rf QQ.AppDir/resources/app/sharp-linux-x64.node
          rm -rf QQ.AppDir/resources/app/AudioFoundation.dylib
          rm -rf QQ.AppDir/resources/app/AudioFoundation.node
          rm -rf QQ.AppDir/resources/app/resource
          rm -rf QQ.AppDir/resources/app/app_launcher
          rm -rf QQ.AppDir/chrome_crashpad_handler
          rm -rf QQ.AppDir/locales/en-US.pak
          
  
      - name: Prepare AppDir structure
        run: |
          mkdir -p QQ.AppDir/usr/lib
          cat > QQ.AppDir/qq.desktop <<EOL
          [Desktop Entry]
          Name=QQ
          Comment=QQ Instant Messenger
          Exec=qq
          Icon=qq
          Type=Application
          Categories=Network;InstantMessaging;
          EOL
      
      - name: Inject specified system libraries into AppDir (Glibc Excluded)
        run: |
          PACKAGE_LIST="libglib2.0-0 libgtk-3-0 libx11-6 libnss3 libgcrypt20 libxext6 libxrender1 libasound2 libdbus-1-3 libxss1 libxtst6 libxkbfile1 libpangocairo-1.0-0"
          BLACKLIST_PATTERN='lib(c|dl|m|pthread|rt|resolv|nss_dns|nss_files|nss_compat|gio|glib)(-[0-9.]*)?\.so(\.[0-9.]*)*$'
          for PKG in $PACKAGE_LIST; do
            dpkg -L "$PKG" | grep '\.so\(\.[0-9.]*\)*$' | egrep -v "$BLACKLIST_PATTERN" | while read -r lib_file; do
              if [ -f "$lib_file" ]; then
                cp -v "$lib_file" QQ.AppDir/usr/lib/
              fi
            done
          done

      
      # - name: Manually bundle remaining dependencies (Glibc Excluded)
      #   run: |
      #         ldd QQ.AppDir/qq | grep "=> /" | awk '{print $3}' | \
      #         egrep -v 'ld-linux|lib(c|z|linux_compat|dl|m|pthread|rt|resolv|nss_dns|nss_files|nss_compat|util|X11|Xext|GL|GLdispatch|EGL|gio|glib)(-[0-9.]*)?\.so(\.[0-9.]*)*$' | \
      #         while read -r lib_path; do
      #             if [ -f "$lib_path" ]; then
      #               cp -nv "$lib_path" QQ.AppDir/usr/lib/
      #             fi
      #         done


      - name: Download appimagetool
        run: |
          wget -O appimagetool.AppImage "https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage"
          chmod +x appimagetool.AppImage

      # ------------------ 核心修改部分 ------------------
      - name: Build AppImage with final name
        run: |
          # 1. 提取 appimagetool
          ./appimagetool.AppImage --appimage-extract
          
          # 2. 运行提取出的工具，并直接指定源目录和最终输出文件名
          # 格式: appimagetool [源] [目标]
          ./squashfs-root/AppRun QQ.AppDir "QQ-NapCat-${{ github.event.inputs.napcat_version }}.AppImage"

      # 将上传步骤独立出来，并直接使用已生成好的文件名
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: "QQ-NapCat-${{ github.event.inputs.napcat_version }}"
          path: "QQ-NapCat-${{ github.event.inputs.napcat_version }}.AppImage"
      # ------------------ 修改结束 ------------------
