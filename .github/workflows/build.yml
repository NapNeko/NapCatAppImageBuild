name: Build NapCat QQ AppImage (Debian container, no FUSE)

on:
  workflow_dispatch:
    inputs:
      napcat_version:
        description: 'NapCat Version (e.g., v4.8.119)'
        required: true
        default: 'v4.8.119'
      qq_version:
        description: 'QQ AppImage URL (完整下载链接)'
        required: true
        default: 'https://dldir1v6.qq.com/qqfile/qq/QQNT/c773cdf7/linuxqq_3.2.19-39038_x86_64.AppImage'

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: ubuntu:22.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          apt-get update
          apt-get install -y --no-install-recommends \
            wget unzip sed patchelf libglib2.0-0 libgtk-3-0 libgtk2.0-0 libgdk-pixbuf2.0-0 \
            libx11-6 libnss3 libgcrypt20 libxext6 libxrender1 libasound2 libdbus-1-3 \
            libxss1 libxtst6 libxkbfile1 file libpangocairo-1.0-0 xvfb xauth \
            ca-certificates fuse curl libappindicator1 libdbus-glib-1-2
          update-ca-certificates

      - name: Download QQ AppImage
        run: |
          wget -O QQ.AppImage "${{ github.event.inputs.qq_version }}"
          chmod +x QQ.AppImage

      - name: Extract QQ AppImage (no FUSE)
        run: |
          ./QQ.AppImage --appimage-extract
          mv squashfs-root QQ.AppDir

      - name: Download NapCat
        run: |
          wget -O NapCat.Shell.zip "https://github.com/NapNeko/NapCatQQ/releases/download/${{ github.event.inputs.napcat_version }}/NapCat.Shell.zip"
          unzip NapCat.Shell.zip -d NapCat
          rm NapCat.Shell.zip

      - name: Inject NapCat into QQ
        run: |
          mkdir -p QQ.AppDir/napcat
          cp -r NapCat/* QQ.AppDir/napcat/
          echo "(async () => {await import('file:///napcat/napcat.mjs');})();" > QQ.AppDir/resources/app/loadNapCat.js
          sed -i 's|"main": "[^"]*"|"main": "./loadNapCat.js"|' QQ.AppDir/resources/app/package.json

      - name: Create simple desktop file
        run: |
          cat > QQ.AppDir/qq.desktop <<EOL
          [Desktop Entry]
          Name=QQ
          Comment=QQ Instant Messenger
          Exec=qq
          Icon=qq
          Type=Application
          Categories=Network;InstantMessaging;
          EOL

      - name: Download linuxdeploy
        run: |
          wget -O linuxdeploy.AppImage https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          chmod +x linuxdeploy.AppImage

      - name: Extract linuxdeploy (no FUSE)
        run: |
          ./linuxdeploy.AppImage --appimage-extract
          mv squashfs-root linuxdeploy-root

      - name: 下载并提取 libindicator7
        run: |
              wget https://archive.ubuntu.com/ubuntu/pool/universe/libi/libindicator/libindicator7_16.10.0+18.04.20180321.1-0ubuntu1_amd64.deb
              dpkg-deb -x libindicator7_16.10.0+18.04.20180321.1-0ubuntu1_amd64.deb tmp
              mkdir -p /usr/lib/x86_64-linux-gnu/
              cp tmp/usr/lib/x86_64-linux-gnu/libindicator.so.7* /usr/lib/x86_64-linux-gnu/
              ldconfig
              ldconfig -p | grep libindicator

      - name: Bundle GTK and dependencies
        run: |
          ./linuxdeploy-root/AppRun \
            --appdir QQ.AppDir \
            --executable QQ.AppDir/qq \
            --desktop-file QQ.AppDir/qq.desktop \
            --icon-file QQ.AppDir/qq.png \
            --plugin gtk \
            --output appimage

      - name: Rename and upload artifact
        run: |
          mv QQ-x86_64.AppImage QQ-NapCat-${{ github.event.inputs.napcat_version }}.AppImage
      - uses: actions/upload-artifact@v4
        with:
          name: "QQ-NapCat-${{ github.event.inputs.napcat_version }}"
          path: "QQ-NapCat-${{ github.event.inputs.napcat_version }}.AppImage"
